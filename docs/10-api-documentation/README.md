# API Documentation (Swagger/OpenAPI) for Autonomous Coding Agent

Comprehensive, accurate, and easy-to-use API documentation is crucial for developers building on or integrating with the Autonomous Coding Agent platform. This guide outlines the strategy for generating and maintaining API documentation using the **OpenAPI Specification (OAS3)**, focusing on a code-first approach for the Node.js/Express.js backend.

## Overview

*   **Purpose:** To provide a clear, interactive, and machine-readable description of the platform's REST APIs. This includes all exposed endpoints (e.g., for managing projects, AI workflows, triggering agent tasks), request/response formats (JSON), authentication methods (JWT Bearer, API Keys), parameters, and error codes.
*   **Standard:** OpenAPI Specification v3.x (OAS3).
*   **Benefits:**
    *   **Interactive Documentation:** Tools like Swagger UI allow developers to explore and test API calls directly.
    *   **Client SDK Generation:** Facilitates auto-generation of client libraries.
    *   **API Consistency:** Encourages a consistent API design.
    *   **Automated Testing:** Enables contract testing.

## API Documentation Strategy: Code-First with Annotations

For the Node.js/Express.js backend, a **code-first approach** is recommended using libraries that generate the OpenAPI specification from JSDoc comments or decorators directly in the route handler and controller files.

*   **Tooling:**
    *   `swagger-jsdoc`: Reads JSDoc comments in your JavaScript/TypeScript files to generate an `openapi.json` or `openapi.yaml` specification.
    *   `swagger-ui-express`: Serves the Swagger UI interface, using the specification generated by `swagger-jsdoc`.
*   **Process:**
    1.  Developers annotate their Express route definitions and associated controller functions with JSDoc comments formatted for `swagger-jsdoc`.
    2.  Define reusable schemas (for request/response bodies, parameters) in a central part of the OpenAPI definition or in JSDoc comments.
    3.  The main Express application (`server/src/main.js` or `app.js`) initializes `swagger-jsdoc` to parse these annotations and generate the OpenAPI specification object.
    4.  `swagger-ui-express` is then used to serve an interactive API documentation page (e.g., at `/api-docs`).
*   **Pros:** Documentation lives directly with the code, increasing the likelihood of it being kept up-to-date by developers as they modify API endpoints.
*   **Cons:** Requires developer discipline to write and maintain comprehensive JSDoc annotations. Can slightly clutter route files if not managed well.

### Key Information to Include in OpenAPI Specification:

For each API endpoint (e.g., `/api/v1/projects`, `/api/v1/workflows/{workflowId}/execute`):
*   **Path & HTTP Method:** e.g., `GET /projects`, `POST /workflows/{workflowId}/execute`.
*   **Summary & Description:** Clear explanation of the endpoint's purpose.
*   **Tags:** To group related endpoints (e.g., "Projects", "AI Workflows", "Authentication").
*   **Parameters:** Path, query, header parameters with descriptions, types, required status, and examples.
*   **Request Body:** For `POST`, `PUT`, `PATCH`. Description, content type (`application/json`), and a schema defining the JSON structure (referencing reusable schemas from `components.schemas`).
*   **Responses:** For all possible HTTP status codes (200, 201, 400, 401, 403, 404, 500). Each includes a description, content type, and response body schema (referencing `components.schemas`).
*   **Authentication/Security Schemes:**
    *   Define `BearerAuth` (for JWTs) and `ApiKeyAuth` (for platform API keys/PATs).
      ```yaml
      # Part of the main swaggerDefinition object
      components:
        securitySchemes:
          BearerAuth:
            type: http
            scheme: bearer
            bearerFormat: JWT
            description: "User's JWT access token (prefix with 'Bearer ')"
          ApiKeyAuth: # For platform's own API Keys/PATs
            type: apiKey
            in: header
            name: Authorization # Assuming 'Bearer YOUR_AGENT_API_KEY'
            description: "Agent's Personal Access Token (prefix with 'Bearer ')"
            # Or if using a custom header like X-API-Key:
            # name: X-API-KEY
            # description: "Agent's Personal Access Token"
      ```
    *   Apply these schemes to relevant operations using the `security` keyword.
*   **Servers:** Define base URLs for development, staging, and production environments.
*   **Reusable Schemas (`components.schemas`):** Define common data structures (e.g., `User`, `Project`, `AIWorkflow`, `WorkflowRun`, `ErrorResponse`) once and reference them using `$ref`. This is crucial for consistency and maintainability. Prisma model definitions can heavily inform these schemas.

### Tooling Setup Example (Conceptual in `server/src/main.js`)
```javascript
// server/src/main.js (or app.js)
const express = require('express');
const swaggerJsdoc = require('swagger-jsdoc');
const swaggerUi = require('swagger-ui-express');
// ... other imports for your app ...

const app = express();
// ... other app.use() middleware ...

// --- Swagger/OpenAPI Definition ---
const swaggerDefinition = {
  openapi: '3.0.3',
  info: {
    title: 'Autonomous Coding Agent API',
    version: '1.0.0', // Correlate with your package.json version
    description: 'REST API for the Autonomous Coding Agent platform, enabling management of projects, AI workflows, and agent tasks.',
    contact: {
      name: 'API Support',
      // url: 'https://your-platform.com/developer',
      // email: 'api-support@your-platform.com',
    },
    license: {
      name: 'Proprietary - See EULA', // Or your chosen license
      // url: 'https://your-platform.com/license',
    },
  },
  servers: [
    { url: `http://localhost:${process.env.SERVER_PORT || 8080}/api/v1`, description: 'Local Development Server' },
    // { url: 'https://staging-api.your-platform.com/api/v1', description: 'Staging Server' },
    // { url: 'https://api.your-platform.com/api/v1', description: 'Production Server' },
  ],
  components: {
    securitySchemes: {
      BearerAuth: { type: 'http', scheme: 'bearer', bearerFormat: 'JWT' },
      AgentApiKeyAuth: { type: 'apiKey', in: 'header', name: 'Authorization', description: "Prefix with 'Bearer YOUR_AGENT_API_KEY'" }
    },
    schemas: {
      // --- Define common schemas here, e.g., based on Prisma models ---
      ErrorResponse: {
        type: 'object',
        properties: {
          message: { type: 'string', example: 'Resource not found.' },
          errors: { type: 'array', items: { type: 'object', properties: { field: {type: 'string'}, message: {type: 'string'}}}}
        },
      },
      User: { /* ... schema for User model ... */ },
      Project: { /* ... schema for Project model ... */ },
      AIWorkflow: { /* ... schema for AIWorkflow model ... */ },
      // ... other core models
    },
  },
  // Apply global security definitions if most endpoints require them
  // security: [{ BearerAuth: [] }, { AgentApiKeyAuth: [] }], // This means OR condition
};

const options = {
  swaggerDefinition,
  // Path to the API docs (JSDoc comments in route files)
  // This should point to all files containing API route definitions with JSDoc annotations.
  // Example for a modular structure:
  apis: ['./src/modules/**/*.routes.js', './src/core/auth/auth.routes.js'],
};
const openapiSpecification = swaggerJsdoc(options);

// Serve Swagger UI at /api-docs
app.use('/api-docs', swaggerUi.serve, swaggerUi.setup(openapiSpecification, {
  explorer: true, // Show search bar
  // customCssUrl: '/custom-swagger.css', // Optional custom styling
}));

// --- Mount your API routes (e.g., from src/modules) ---
// app.use('/api/v1/auth', authRoutes);
// app.use('/api/v1/projects', projectRoutes);
// ...

// const PORT = process.env.SERVER_PORT || 8080;
// app.listen(PORT, () => {
//   console.log(`Server running on port ${PORT}`);
//   console.log(`API docs available at http://localhost:${PORT}/api-docs`);
// });
```

### Example JSDoc Annotation for an Express Route:
File: `server/src/modules/projects/project.routes.js`
```javascript
// const express = require('express');
// const projectController = require('./project.controller');
// const { isAuthenticated } = require('../../core/middleware/auth.middleware'); // Your auth middleware

// const router = express.Router();

/**
 * @swagger
 * tags:
 *   name: Projects
 *   description: Project management for the Autonomous Coding Agent
 */

/**
 * @swagger
 * /projects:
 *   get:
 *     summary: Retrieve a list of projects for the authenticated user
 *     tags: [Projects]
 *     security:
 *       - BearerAuth: [] # Indicates this endpoint uses BearerAuth (JWT)
 *     parameters:
 *       - in: query
 *         name: limit
 *         schema: { type: integer, default: 10 }
 *         description: Maximum number of projects to return
 *       - in: query
 *         name: offset
 *         schema: { type: integer, default: 0 }
 *         description: Number of projects to skip for pagination
 *     responses:
 *       '200':
 *         description: A list of projects.
 *         content:
 *           application/json:
 *             schema:
 *               type: array
 *               items:
 *                 $ref: '#/components/schemas/Project' # Reference your defined Project schema
 *       '401':
 *         description: Unauthorized
 *         content:
 *           application/json:
 *             schema:
 *               $ref: '#/components/schemas/ErrorResponse'
 */
// router.get('/', isAuthenticated, projectController.listProjects);

/**
 * @swagger
 * /projects:
 *   post:
 *     summary: Create a new project
 *     tags: [Projects]
 *     security:
 *       - BearerAuth: []
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             $ref: '#/components/schemas/CreateProjectInput' # Define this input schema
 *     responses:
 *       '201':
 *         description: Project created successfully
 *         content:
 *           application/json:
 *             schema:
 *               $ref: '#/components/schemas/Project'
 *       '400':
 *         description: Invalid input
 *         content:
 *           application/json:
 *             schema:
 *               $ref: '#/components/schemas/ErrorResponse'
 *       '401':
 *         description: Unauthorized
 */
// router.post('/', isAuthenticated, projectController.createProject);

// module.exports = router;
```
(You would need to define `CreateProjectInput` in `components.schemas` in the main Swagger definition).

### Documenting Webhooks and Callbacks:
*   **Platform Receiving Webhooks:** If your platform receives webhooks from third parties (e.g., Git provider, payment gateway), these are regular API endpoints on your Node.js server. Document them like any other POST endpoint, specifying the expected request body schema from the third party and security measures (e.g., signature verification header).
*   **Platform Sending Callbacks/Webhooks:** If your platform makes callbacks to client-provided URLs (e.g., for AI task completion), use the OpenAPI `callbacks` object to define the expected request your platform will make.

### Versioning API Documentation:
*   If your API is versioned (e.g., `/api/v1/...`, `/api/v2/...`), maintain separate OpenAPI specifications for each version.
*   The Swagger UI setup can be configured to allow users to select the API version they want to view, potentially by serving different spec files at different `/api-docs/v1`, `/api-docs/v2` paths.

## Maintenance and Best Practices
*   **Keep Annotations Up-to-Date:** As API code changes, JSDoc annotations must be updated. This should be part of the code review process.
*   **Comprehensive Schemas:** Define detailed and accurate schemas for all request/response bodies and parameters. Use Prisma model definitions as a strong reference.
*   **Clear Descriptions:** Use clear, concise language for summaries and descriptions. Explain parameters and response codes thoroughly.
*   **"Try It Out" Feature:** Ensure this is configured for a safe environment (e.g., pointing to a staging or local dev server if Swagger UI is exposed publicly, or clearly marking it for development use only).
*   **CI/CD Validation:** Consider adding a step in your CI/CD pipeline to validate the generated OpenAPI spec (e.g., using `swagger-cli validate`).
*   **API Changelog:** Maintain a separate changelog for API changes, especially breaking ones.

By adopting a code-first approach with `swagger-jsdoc` and `swagger-ui-express`, the Autonomous Coding Agent platform can maintain accurate, interactive, and developer-friendly API documentation that evolves with the codebase.
